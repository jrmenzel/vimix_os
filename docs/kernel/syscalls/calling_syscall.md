# How a Syscall is called

## 1. User Mode

[syscalls](syscalls.md) can be called by the applications as functions of the standard library or indirectly if library functions internally call syscalls.
For example see `usr/include/unistd.h` ("UNIX Standard Header"): `extern int32_t ms_sleep(int32_t milliseconds);`

All syscalls are implemented in assembly in `usys.S`, this file is automatically generated at build time from `usys.pl` as the assembly is the same for all calls, so this avoids a lot of copy and paste. Here is the [ms_sleep](ms_sleep.md) syscall:

```
.global ms_sleep
ms_sleep:
li a7, SYS_ms_sleep
ecall
bge a0, zero, 1f
neg a0, a0
sw a0, errno, t0
li a0,-1
1:
ret
```

It defines a global label (so other files can call the functions), loads a constant into `a7` (the syscall number) and calls [ecall](../../riscv/ecall.md) which switches to supervisor mode and into a OS function. Function parameters are placed in registers.

`syscall()` gets called. It gets the syscall number from the saved trapframe and calls the matching syscall (all are in an array sorted by number). It then stores the return value into the trapframe.

Most syscalls return a negative value on error which encodes a value from `errno.h`. The C API expects `-1` on all errors and the detailed error code in the global variable `errno`. Storing the value and returning `-1` is done in the assembly stubs generated by `usys.pl`.


## How to add a new Syscall

- Add a function declaration to the user mode libraries. (`void my_call();`)
- Add a syscall number to `kernel/include/kernel/unistd.h`. (`#define SYS_my_call 42`)
- Add a macro call to `usys.pl` (`entry("my_call");`)
- Add the kernel side function declaration to `syscall.h` (`void sys_my_call();`) and add it to the `syscalls` array which maps the syscall numbers to functions (`[SYS_my_call] sys_my_call,`).
- Implement `void sys_my_call();` (other implementations are in `syscalls/sys_*.c`).


---
**Overview:** [kernel](../kernel.md)

**Boot:** [boot_process](../overview/boot_process.md) | [init_overview](../overview/init_overview.md)

**Subsystems:** [interrupts](../interrupts/interrupts.md) | [devices](../devices.md) | [file_system](file_system.md) | [memory_management](../mm/memory_management.md)
[processes](../processes/processes.md) | [scheduling](../processes/scheduling.md) | [syscalls](../syscalls.md)
